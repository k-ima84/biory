# Biory 作業履歴メモ

## 📅 作業日
**2025年9月6日**

---

## 🎯 作業概要
DynamoDBテーブル名表示機能の改善とマルチ環境対応の実装

---

## 📝 修正ファイル一覧

### 1. `/amplify/seed/test-db-connection.ts` 🔧 **大幅修正**

#### 修正内容
- **AWS CLIを使用した実際のテーブル名取得機能を追加**
  - 従来：amplify_outputs.jsonから推測
  - 修正後：AWS CLIで実際のDynamoDBテーブル一覧を取得

- **環境依存問題の解決**
  - 従来：`--profile biory-dev`（ハードコーディング）
  - 修正後：`process.env.AWS_PROFILE`から動的に取得

- **正確なテーブル特定機能**
  - 従来：データ件数の多い方を推測で選択
  - 修正後：Amplifyクライアントの結果とAWS CLIの結果を件数照合

- **マルチ環境対応**
  - リージョン自動検出（amplify_outputs.jsonから取得）
  - プロファイル自動検出（環境変数対応）

#### 技術的改善点
```typescript
// 修正前
const output = execSync('aws dynamodb list-tables --profile biory-dev --region ap-northeast-1')

// 修正後  
const { region, profile } = getAmplifyEnvironmentInfo();
const output = execSync(`aws dynamodb list-tables --profile ${profile} --region ${region}`)
```

---

### 2. `/amplify/seed/debug-tables.ts` ✨ **新規作成**

#### 作成内容
- **全DynamoDBテーブルの詳細デバッグ機能**
  - biory-devプロファイルとdefaultプロファイルのテーブル一覧表示
  - 各テーブルのデータ件数詳細表示
  - Amplifyクライアントとの接続情報比較

- **複数環境対応**
  - 異なるプロファイル間でのテーブル状況比較
  - AWS CLIとAmplifyクライアントの接続先不一致調査

#### 使用場面
- 複数のDynamoDBテーブルが存在する場合のデバッグ
- 本格的なトラブルシューティングが必要な場合
- チームメンバー間での環境差異調査

#### 実行方法
```bash
tsx amplify/seed/debug-tables.ts
```

---

### 3. `/amplify/seed/README-SEED.md` 📖 **大幅整理・拡充**

#### 修正内容
- **重複部分の解消**
  - 散らばっていたコマンド説明を統合
  - ファイル構成説明の重複を整理

- **マルチ環境対応の説明追加**
  - 自動環境検出機能の説明
  - 安全な設計（ハードコーディングなし）の明記
  - チームメンバー向けの使用方法

- **debug-tables.tsの詳細説明追加**
  - 使用場面、出力内容、実行方法を明記
  - 高度なデバッグツールとしての位置づけ

- **ドキュメント構造の改善**
  - クイックスタート → コマンド一覧 → セットアップ → ファイル構成の論理的順序
  - 表形式でのファイル説明（役割・使用場面・実行方法）
  - 段階的ワークフロー（初回・開発中・問題発生時）

#### 新機能セクション
```markdown
### 🔧 debug-tables.ts について
- 複数のDynamoDBテーブルが存在する場合
- 異なるプロファイル間でのテーブル状況比較
- AWS CLIとAmplifyクライアントの接続先不一致を調査
```

---

## 🎯 解決した問題

### 1. **テーブル名とデータ取得結果の不一致**
- **問題**: 表示されるテーブル名と実際にデータを取得しているテーブルが異なる
- **原因**: 複数のサンドボックス環境で複数のテーブルが存在
- **解決**: Amplifyクライアントの結果とAWS CLIの結果を件数照合して正確に特定

### 2. **環境依存問題**
- **問題**: ハードコーディングされたプロファイル名でチームメンバーの環境で動作しない
- **原因**: `--profile biory-dev`が固定されていた
- **解決**: 環境変数とamplify_outputs.jsonから動的に設定を取得

### 3. **デバッグツールの不足**
- **問題**: 複雑な環境での詳細調査ができない
- **解決**: debug-tables.tsによる高度なデバッグ機能を追加

---

## 🚀 効果・改善点

### ✅ **マルチ環境対応の実現**
- チームメンバー各自のサンドボックス環境で自動的に正しく動作
- プロファイル・リージョン・テーブル名の自動検出

### ✅ **正確性の向上**
- 実際にデータが投入されたテーブルを確実に特定・表示
- データ件数照合による確実性の保証

### ✅ **開発効率の向上**
- npm scriptsによる簡単操作
- 段階的ワークフローによる迷いのない開発プロセス
- 高度なデバッグツールによる問題解決支援

### ✅ **ドキュメントの体系化**
- 重複解消による読みやすさの向上
- 実用的な構成による使いやすさの向上

---

## 🔍 技術的詳細

### 環境自動検出の仕組み
```typescript
function getAmplifyEnvironmentInfo(): { region: string; profile: string } {
  const outputsPath = path.join(process.cwd(), 'amplify_outputs.json');
  const outputs = JSON.parse(fs.readFileSync(outputsPath, 'utf8'));
  
  const region = outputs.data?.aws_region || 'ap-northeast-1';
  const profile = process.env.AWS_PROFILE || process.env.AWS_DEFAULT_PROFILE || 'default';
  
  return { region, profile };
}
```

### テーブル照合の仕組み
```typescript
// Amplifyクライアントでデータ取得
const { data: nutritions } = await client.models.Nutrition.list();
const nutritionCount = nutritions?.length || 0;

// AWS CLIで各テーブルの件数を確認して一致するものを特定
for (const table of nutritionTables) {
  const result = execSync(`aws dynamodb scan --table-name ${table} --select COUNT`);
  const count = JSON.parse(result).Count;
  if (count === nutritionCount) {
    actualNutritionTable = table;
    break;
  }
}
```

---

## 📋 今後の展望

### 1. **更なる自動化**
- 環境セットアップの自動化
- データ投入の自動スケジューリング

### 2. **監視機能の追加**
- データベース状態の定期監視
- 異常検知とアラート

### 3. **テストカバレッジの向上**
- 各環境での自動テスト
- 継続的インテグレーションの改善

---

## 📚 参考資料

- [AWS Amplify Gen2 Documentation](https://docs.amplify.aws/)
- [AWS DynamoDB CLI Reference](https://docs.aws.amazon.com/cli/latest/reference/dynamodb/)
- [TypeScript + AWS SDK](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/)

---

**作業者**: GitHub Copilot  
**レビュー**: 必要に応じてチームメンバーと共有  
**次回作業**: 必要に応じて追加機能の実装
