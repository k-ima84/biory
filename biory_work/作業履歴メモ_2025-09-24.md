# 作業履歴メモ 2025-09-24

## 実装内容：ホーム画面にCognitoユーザー情報表示機能を追加

### 変更ファイル
1. `/app/biory/home/page.tsx`
2. `/app/biory/home/home.css`

---

## 1. `/app/biory/home/page.tsx` の変更内容

### 追加したimport
```typescript
import { getCurrentUser, fetchUserAttributes } from 'aws-amplify/auth';
```

### 追加した状態変数
```typescript
const [cognitoUserId, setCognitoUserId] = useState<string>("");
const [userEmail, setUserEmail] = useState<string>("");
```

### 追加したCognito情報取得関数
```typescript
// Cognitoユーザー情報を取得する関数
const fetchCognitoUserInfo = async () => {
  try {
    // 現在認証されているユーザーの情報を取得
    const user = await getCurrentUser();
    const userId = user.userId; // CognitoのユニークなユーザーID (sub)
    setCognitoUserId(userId);

    // ユーザーの属性（メールアドレスなど）を取得
    const userAttributes = await fetchUserAttributes();
    const email = userAttributes.email || "";
    const preferredUsername = userAttributes.preferred_username || "";
    const name = userAttributes.name || "";
    
    setUserEmail(email);

    // 表示用の名前を決定（name > preferred_username > email のユーザー名部分 の優先順位）
    let displayName = "ユーザー";
    if (name) {
      displayName = name;
    } else if (preferredUsername) {
      displayName = preferredUsername;
    } else if (email) {
      displayName = email.split('@')[0];
    }

    return displayName;
  } catch (error) {
    console.error("Cognito情報取得エラー:", error);
    
    if (error instanceof Error) {
      // 認証されていない場合はログイン画面へ
      router.push("/biory/login");
      return "ゲスト";
    }
  }
};
```

### 修正したfetchUserProfile関数
```typescript
// ユーザープロフィールを取得する関数
const fetchUserProfile = async () => {
  try {
    // まずCognitoユーザー情報を取得
    const cognitoDisplayName = await fetchCognitoUserInfo();
    
    // 次にプロファイルデータベースから情報を取得
    const { data: profiles } = await client.models.UserProfile.list();
    if (profiles && profiles.length > 0) {
      const profile = profiles[0];
      // データ���ースに名前があればそれを使用、なければCognitoの表示名を使用
      setUserName(profile.name || cognitoDisplayName);

      // Null合体演算子を使用してデフォルト値を設定
      setHealthData(prev => ({
        ...prev,
        weight: profile.weight ?? 0  // null または undefined の場合は 0
      }));
    } else {
      // プロファイルがない場合はCognitoの表示名を使用
      setUserName(cognitoDisplayName);
    }
  } catch (error) {
    console.error("ユーザープロフィール取得エラー:", error);
    setUserName("ゲスト");
  }
};
```

### 追加したJSX要素
```typescript
{/* 日付・挨拶セクション */}
<section className="date-greeting">
  <div className="date">{currentDate}</div>
  <div className="greeting">こんにちは！{userName}さん</div>
  {cognitoUserId && (
    <div className="cognito-info">
      <div className="cognito-id">CognitoID: {cognitoUserId}</div>
      {userEmail && <div className="user-email">Email: {userEmail}</div>}
    </div>
  )}
</section>
```

---

## 2. `/app/biory/home/home.css` の変更内容

### 追加したCSSスタイル
```css
/* Cognito情報表示スタイル */
.cognito-info {
  margin-top: 10px;
  padding: 8px;
  background-color: #f8f9fa;
  border-radius: 4px;
  font-size: 12px;
  color: #666;
}

.cognito-id {
  margin-bottom: 4px;
  font-family: monospace;
}

.user-email {
  font-style: italic;
}
```

---

## 機能概要

### 実装した機能
1. **Cognitoユーザー情報の自動取得**
   - ログイン時のCognitoユーザーID（sub）を取得
   - ユーザーのメールアドレスを取得
   - 表示名の自動決定（name → preferred_username → email の優先順位）

2. **ホーム画面での情報表示**
   - 挨拶セクションの下にCognito情報を表示
   - CognitoIDとEmailを小さなボックス内に表示
   - 認証されていない場合は自動的にログイン画面へリダイレクト

3. **エラーハンドリング**
   - Cognito認証エラー時の適切な処理
   - ログイン画面への自動リダイレクト機能

### 表示される情報
- **ユーザー名**: データベースの名前 または Cognitoから取得した表示名
- **CognitoID**: `CognitoID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- **Email**: `Email: user@example.com`

### 技術仕様
- **認証**: AWS Cognito User Pool
- **データ取得**: `getCurrentUser()`, `fetchUserAttributes()` from aws-amplify/auth
- **状態管理**: React useState hooks
- **スタイリング**: グレー背景、小フォント、等幅フォント使用

---

---

## Cognito情報取得の動作について

### 現在の実装動作
**毎回Cognitoにアクセスしています** - キャッシュは使用していません

#### 具体的な動作パターン：

1. **初回ホーム画面表示時**
   ```typescript
   useEffect(() => {
     fetchUserProfile(); // ←ここでCognito情報を取得
   }, []);
   ```

2. **画面遷移後の再表示時**
   - ホーム画面に戻るたびに`useEffect`が実行される
   - `fetchUserProfile()` → `fetchCognitoUserInfo()` が呼ばれる
   - `getCurrentUser()` と `fetchUserAttributes()` でCognitoに毎回アクセス

3. **ページフォーカス時**
   ```typescript
   const handleFocus = () => {
     fetchUserProfile(); // ←フォーカス時にもCognito情報を再取得
   };
   window.addEventListener('focus', handleFocus);
   ```

### パフォーマンスへの影響

#### 現在の問題点：
- **ネットワーク負荷**: 画面遷移のたびにCognitoへのAPIコール
- **レスポンス時間**: 毎回認証サーバーとの通信が発生
- **不要な処理**: ユーザー情報は変更頻度が低いのに毎回取得

#### 推奨される改善方法：
1. **Context API + キャッシュ**
   ```typescript
   // UserContextを作成してアプリ全体で共有
   const UserContext = createContext();
   ```

2. **localStorage活用**
   ```typescript
   // 一度取得した情報をlocalStorageに保存
   localStorage.setItem('cognitoUserInfo', JSON.stringify(userInfo));
   ```

3. **セッションキャッシュ**
   ```typescript
   // sessionStorageでブラウザセッション中は保持
   sessionStorage.setItem('userInfo', JSON.stringify(userInfo));
   ```

### セキュリティ考慮事項
- **JWTトークンの有効期限**: Cognitoトークンは通常1時間で期限切れ
- **リフレッシュの必要性**: 定期的な認証状態確認は必要
- **機密情報の保護**: ユーザーIDは保存OK、トークン自体の保存は注意が必要

---

## 次の実装予定
- 献立再作成機能のAmazon Bedrock連携
- HTTP API Gateway経由でのLambda関数呼び出し
- AI による食事メニュー生成機能
- **Cognito情報のキャッシュ機能実装** （パフォーマンス改善）
